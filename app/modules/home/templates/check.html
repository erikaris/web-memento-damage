{% extends 'frontpage.html' %}

{% block title %}Check Damage{% end %}

{% block head %}
  <style type="text/css">
    .important {
      color: #336699;
    }

    select[name^=type] {
        width: 100px !important;
    }

    .tab-content {
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-top: 0px;
      background-color: #fff;
    }
    
    #screenshots img {
      width: 100%;
    }

    .result-list .title {
      font-weight: bold;
      overflow-x: hidden;
      cursor: pointer;
      color: #5cb85c;
    }    
    .result-list .title span {
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
    }
    
    .result-list .detail {
      margin-left: 20px;
    }    
    .result-list .detail .item {
      display: table-row;
    }    
    .result-list .detail .item div {
      display: table-cell;
      padding: 0 5px;
    }

    .log-line {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding: 3px;
    }
    .log-line:nth-child(even) {
      background: #CCC
    }
    .log-line:nth-child(odd) {
      background: #FFF
    }
  </style>
{% end %}

{% block content %}
<!-- Check archive section -->
<section id="subscribe-section" class="subscribe-section text-center">
  <div class="container">
    <div class="col-sm-10 col-sm-offset-1">
      <div class="col-sm-8 col-sm-offset-2">
        <h3>Check damage of your website</h3>
      </div>
      <div class="col-sm-8 col-sm-offset-2">
        <form class="news-letter" method="GET" action="/memento/check">
          <div class="subscribe-hide">
            <div class="input-group">
              <input class="form-control" type="text" name="url" placeholder="http://www.somesite.com" required />
              <span class="input-group-btn">
                <button class="btn btn-success" type="submit">Check Again &raquo;</button>
              </span>
            </div><!-- /input-group -->
            <div class="subscribe-error"></div>
          </div><!-- /.subscribe-hide -->
          <div class="subscribe-message"></div>
        </form><!-- /.news-letter -->
      </div>
    </div>
  </div><!-- /.container -->
</section><!-- /#subscribe-section -->
<!-- End check archive section -->

<section id="result">
  <div class="container">
    <div class="row"> <!--Message result-->
      <div class="col-sm-10 col-sm-offset-1">
        <div id="alert-is-archive" style="display:none" class="alert alert-warning" role="alert">
          <strong>Warning!</strong> This result is an archive damage calculation
          that was done in <strong><span id="archive-time"></span></strong>. 
          To make fresh calculation follow this URI 
          <strong><a id="fresh-uri" href="#">Fresh Calculation</a></strong>
        </div>
      </div>
    </div>

    <div class="row"> <!--Tab result-->
      <div class="col-sm-10 col-sm-offset-1">
        <ul class="nav nav-tabs">
          <li class="active"><a data-toggle="tab" href="#summary">
            <i class="tab-icon fa fa-circle-o-notch fa-spin"></i>&nbsp;Summary</a>
          </li>
          <li class="uri-r"><a data-toggle="tab" href="#mementos">
            <i class="tab-icon fa fa-circle-o-notch fa-spin"></i>&nbsp;Mementos</a>
          </li>
          <li><a data-toggle="tab" href="#images">
            <i class="tab-icon fa fa-circle-o-notch fa-spin"></i>&nbsp;Images</a>
          </li>
          <li><a data-toggle="tab" href="#csses">
            <i class="tab-icon fa fa-circle-o-notch fa-spin"></i>&nbsp;Stylesheets</a>
          </li>
          <li><a data-toggle="tab" href="#screenshots">
            <i class="tab-icon fa fa-circle-o-notch fa-spin"></i>&nbsp;Screenshots</a>
          </li>
          <li class="fresh"><a data-toggle="tab" href="#log">
            <i class="tab-icon fa fa-circle-o-notch fa-spin"></i>&nbsp;Log</a>
          </li>
        </ul>
        <div class="tab-content">
          <div class="tab-pane fade in active" id="summary">
            <h3>Summary</h3>
          </div>
          <div class="tab-pane fade" id="mementos">
            <h3>List of URI-M</h3>
          </div>
          <div class="tab-pane fade" id="images">
            <h3>List of Images</h3>
          </div>
          <div class="tab-pane fade" id="csses">
            <h3>List of Csses</h3>
          </div>
          <div class="tab-pane fade" id="screenshots"></div>
          <div class="tab-pane fade" id="log">
            <h3>Log Progress</h3>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% end %}

{% block tail %}
<script src="{{ static_url('assets/js/md5.js') }}"></script>
<script type="text/javascript">
  $('input[name=url]').val('{{ url }}');
  $('select[name=type]').val('{{ type }}');

  function toggleChevron(e) {
    $(e.target)
      .find("i.indicator")
      .toggleClass('glyphicon-chevron-down glyphicon-chevron-up');
  }
  
  function showScreenshot(uri) {
    $('<img>').attr('src', '/memento/screenshot?url=' + uri)
      .appendTo($('#screenshots'));
  }
  
  function showSummary(result) {
    var olImages = $('<ol class="result-list">').appendTo('#summary');
    
    var liImage = $('<li>').appendTo(olImages);
      var divTitle = $('<div class="title" data-toggle="collapse">')
        .attr('data-target', '#potential-damage')
        .appendTo(liImage);
      $('<span>').html('Potential Damage').appendTo(divTitle);
      $('<span>').html(result['potential_damage']).appendTo(divTitle);
      
    var divContent = $('<div class="collapse detail" id="potential-damage">')
      .appendTo(liImage);
    
    var liImage = $('<li>').appendTo(olImages);
      var divTitle = $('<div class="title" data-toggle="collapse">')
        .attr('data-target', '#actual-damage')
        .appendTo(liImage);
      $('<span>').html('Potential Damage').appendTo(divTitle);
      $('<span>').html(result['actual_damage']).appendTo(divTitle);
      
    var divContent = $('<div class="collapse detail" id="actual-damage">')
      .appendTo(liImage);
    
    var liImage = $('<li>').appendTo(olImages);
      var divTitle = $('<div class="title" data-toggle="collapse">')
        .attr('data-target', '#total-damage')
        .appendTo(liImage);
      $('<span>').html('Potential Damage').appendTo(divTitle);
      $('<span>').html(result['total_damage']).appendTo(divTitle);
      
    var divContent = $('<div class="collapse detail" id="total-damage">')
      .appendTo(liImage);
  }
  
  function showImages(images) {
    var olImages = $('<ol class="result-list">').appendTo('#images');
    
    images.forEach(function(image) {
      var liImage = $('<li>').appendTo(olImages);
      var divTitle = $('<div class="title">')
        .attr('data-toggle', 'collapse')
        .attr('data-target', '#image-' + md5(image['url']))  
        .appendTo(liImage);
      $('<span>').html(image['url']).appendTo(divTitle);
      $('<span>').html('status_code' in image ? 
                       image['status_code'] : '').appendTo(divTitle);
      
      var divContent = $('<div class="collapse detail">')
        .attr('id', 'image-' + md5(image['url']))
        .appendTo(liImage);
      $('<div class="item"><div>Content-Type</div><div> : </div><div>'+ 
        image['content_type'] +'</div></div>').appendTo(divContent);
      var rectangles = [];
      image['rectangles'].forEach(function(rect) {
        rectangles.push('Left: ' + rect['left'] + ' px, Top: ' + rect['top'] +
          ' px, Width: ' + rect['width'] + ' px, Height: ' + rect['height'] + ' px');
      });
      $('<div class="item"><div>Rectangles</div><div> : </div><div>'+ 
        rectangles.join('<br/>') +'</div></div>').appendTo(divContent);
    });
  }
  
  function showStylesheets(csses) {
    var olImages = $('<ol class="result-list">').appendTo('#csses');
    
    csses.forEach(function(css) {
      var liImage = $('<li>').appendTo(olImages);
      var divTitle = $('<div class="title">')
        .attr('data-toggle', 'collapse')
        .attr('data-target', '#css-' + md5(css['url']))  
        .appendTo(liImage);
      $('<span>').html(css['url']).appendTo(divTitle);
      $('<span>').html('status_code' in css ? 
                       css['status_code'] : '').appendTo(divTitle);
      
      var divContent = $('<div class="collapse detail">')
        .attr('id', 'css-' + md5(css['url']))
        .appendTo(liImage);
      if(!css['rules_tag']) css['rules_tag'] = [];
      $('<div class="item"><div>Rules Selector</div><div> : </div><div>'+ 
          css['rules_tag'].join(', ') + 
          ' <strong>(Total '+ css['rules_tag'].length +')</strong>' +
        '</div></div>').appendTo(divContent);
      $('<div class="item"><div>Importance</div><div> : </div><div>'+ 
        css['importance'] +'</div></div>').appendTo(divContent);
    });
  }

  // If type is URI-M, hide tab mementos
  if('{{ type }}'.toUpperCase() != 'uri-r'.toUpperCase()) {
    $('.nav .uri-r').hide();
  }

  // Check mementos if type is URI-M
  if('{{ type }}'.toUpperCase() != 'uri-m'.toUpperCase()) {
    $.get('/memento/mementos', { 'uri-r' : '{{ url }}' }, function(memento_uris) {
      // Change icon to checklist
      $('.uri-r .tab-icon').attr('class', 'tab-icon fa fa-check-square-o')

      // Show data in mementos tab
      var ol = $('<ol>').appendTo($('#mementos'));
      memento_uris.forEach(function(uri) {
        var li = $('<li>').appendTo(ol);
        $('<a>').attr('href', uri).html(uri).appendTo(li);
        var spinnerEl = $('<i>').attr('class', 'fa fa-circle-o-notch fa-spin');
        var statusEl = $('<span>').html('Checking...')
        li.append('&nbsp;').append(spinnerEl).append('&nbsp;').append(statusEl);


        // Check damage by calling function checkDamage
        checkDamageUriM(uri, function() {
          // Change icon to checklist
          if(spinnerEl) spinnerEl.attr('class', 'fa fa-check-square-o')
          if(statusEl) statusEl.html('Finished');
        })
      });
    }, 'json');
  } else {
    checkDamageFinished = false;
    checkDamageUriM('{{ url }}', {{ fresh }}, function(uri, result) {
      // Show alert if result is an archive calculation ================================
      if(result['is_archive'] == true) {
        $('#alert-is-archive').show();
        $('#archive-time').html(result['archive_time']);
        $('#fresh-uri').attr('href', window.location.href + '&fresh=true')
          .html(window.location.href + '&fresh=true');
      }
      
      // Show summary ==================================================================
      showSummary(result);

      // Show images and stylesheets ===================================================
      for(var key in result) {
        val = result[key];

        if(key == 'images') {
          showImages(val);
        }
        else if(key == 'csses') {
          showStylesheets(val);
        }
      }
      
      // Show screenshot ===============================================================
      showScreenshot(uri);

      // Change icon to checklist ======================================================
      $('[href="#summary"] .tab-icon').attr('class', 'tab-icon fa fa-check-square-o');
      $('[href="#images"] .tab-icon').attr('class', 'tab-icon fa fa-check-square-o');
      $('[href="#csses"] .tab-icon').attr('class', 'tab-icon fa fa-check-square-o');
      $('[href="#screenshots"] .tab-icon').attr('class', 'tab-icon fa fa-check-square-o');
      $('[href="#log"] .tab-icon').attr('class', 'tab-icon fa fa-check-square-o');

      checkDamageFinished = true;
    });

    // Show progress
    log = $('#log')
    totalLines = 0

    function onFinished(uri, result) {
      if(result.length > 0) {
        lines = result.split('\n');
        lines.forEach(function(line) {
          $('<div class="log-line">').html(line).attr('title', line).appendTo(log);
        });

        totalLines += lines.length;
      }

      if(!checkDamageFinished) {
        progressCheckDamageUriM('{{ url }}', totalLines, onFinished)
      }
    }
    progressCheckDamageUriM('{{ url }}', 0, onFinished)
  }

  function checkDamageUriM(uri, fresh, onFinished) {
    $.get('/memento/damage', { 'uri' : uri, 'fresh' : fresh }, function(result) {
      // Call onFinished callback
      onFinished(uri, result)
    }, 'json');
  }

  function progressCheckDamageUriM(uri, start, onFinished) {
    setTimeout(function() {
      $.get('/memento/damage/progress', { 'uri' : uri, 'start' : start }, function(result) {
        // Call onFinished callback
        onFinished(uri, result)
      });
    }, 3000);
  }
</script>
{% end %}
